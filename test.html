<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demo DataTableLib</title>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 10px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 6px;
        text-align: left;
      }
      th {
        cursor: pointer;
        background: #f0f0f0;
      }
      #loading {
        display: none;
        color: blue;
      }
      #error {
        color: red;
        display: none;
      }
      .pagination {
        margin-top: 10px;
      }
      .pagination button {
        padding: 5px 10px;
        margin: 0 3px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Test DataTableLib</h1>

    <div id="loading">Đang tải...</div>
    <input type="text" id="search-box" placeholder="Tìm kiếm..." />

    <div class="table1">
      <table id="tbl-application">
        <thead></thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="pagination"></div>
    </div>
    <input type="text" id="search-box2" placeholder="Tìm kiếm..." />
    <div class="table2">
      <table id="tbl-application2">
        <thead></thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="pagination2"></div>
    </div>

    <script type="module">
      import { DataTableLib } from "./applib.mjs";
      // helper: đặt ở đầu file cùng với các import (hoặc trước khi dùng)
      function showNoData(tableId, message = "NO DATA") {
        const table = document.getElementById(tableId);
        if (!table) return;
        const tbody =
          table.querySelector("tbody") ||
          table.appendChild(document.createElement("tbody"));

        // remove previous empty row nếu có
        const prev = tbody.querySelector("tr.dt-empty");
        if (prev) prev.remove();

        // tính colspan dựa vào thead nếu có
        let colCount = 1;
        const thead = table.querySelector("thead");
        if (thead) {
          const ths = thead.querySelectorAll("th");
          if (ths.length) colCount = ths.length;
        }

        const tr = document.createElement("tr");
        tr.className = "dt-empty";
        const td = document.createElement("td");
        td.colSpan = colCount;
        td.textContent = message; // safe: dùng textContent để tránh XSS
        td.style.textAlign = "center";
        td.style.color = "#666";
        td.style.padding = "10px 0";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }

      function clearNoData(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const tbody = table.querySelector("tbody");
        if (!tbody) return;
        const prev = tbody.querySelector("tr.dt-empty");
        if (prev) prev.remove();
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const table = new DataTableLib({
          api: "https://dummyjson.com/users?limit=100",
          tableId: "tbl-application",
          searchBoxId: "search-box",
          loadingId: "loading",
          rows: 10,
          serverSide: false,
          sortable: true,
          pagination: true,
          paginationId: "pagination",
          searchDebounceMs: 650,
          columnsConfig: [
            { field: "id", label: "ID" },
            {
              field: "firstName",
              label: "First Name",
              render: (row) => `<b>${row.firstName}</b>`,
              safeHtml: true,
            },
            {
              field: "email",
              label: "Email",
              render: (row) => `<a href="mailto:${row.email}">${row.email}</a>`,
              safeHtml: true,
            },
          ],
          onError: (err) => console.error("DataTable error:", err),
        });

        await table.init(); // đợi fetch ban đầu xong nếu bạn cần tiếp hành động sau đó
        // BACK-END pagination (serverSide: true)
        const table2 = new DataTableLib({
          api: "https://dummyjson.com/users",
          tableId: "tbl-application2",
          rows: 5,//KHÔNG  có tác dụng vì đã phân back
          serverSide: true, // kích hoạt gọi API phân trang

          sortable: true,
          pagination: true,
          paginationId: "pagination2",
          searchDebounceMs: 650,

          searchBoxId: "search-box2",
          buildUrl: (page, searchTerm) => {
            // const limit = 5;
            const params = {
              limit: 5,
              skip: (page - 1) * 5,
            };

            // const limit = 5;
            // const skip = (page - 1) * limit;
            let url = `https://dummyjson.com/users?${new URLSearchParams( params  ).toString()}`;
            if (searchTerm) url += `&q=${encodeURIComponent(searchTerm)}`;
            return url;
          },
          formatData: (res) => res.users,
          onAfterFetch: (rows) => {
            if (!rows || rows.length === 0)
              showNoData("tbl-application2", "NO DATA");
            else clearNoData("tbl-application2");
          },
          onError: (err) => {
            // nếu muốn hiển thị NO DATA khi error (tuỳ bạn)
            showNoData("tbl-application2", "NO DATA");
            console.error(err);
          },
          rowRenderer: (row) => {
            return `
              <td>${row.id ?? ""}</td>
              <td colspan="2"><strong>${row.firstName ?? ""} ${
              row.lastName ?? ""
            }</strong><br>
                <a href="mailto:${row.email ?? ""}">${row.email ?? ""}</a>
              </td>
            `;
          },
          // tạo header
          columnsConfig: [{ label: "ID" }, { label: " Name merge Email" }],
        });
        table2.init();
      });
    </script>
  </body>
</html>
